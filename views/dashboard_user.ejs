   <!DOCTYPE html> 
<html>
<head>
  <title>User Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: linear-gradient(120deg, #1b1b1b, #333);
      color: #f1f1f1;
      padding: 20px;
      animation: fadeIn 1s ease-in;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .header-container { 
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      text-align: center;
      margin-bottom: 40px;
    }

    .logo-container img { max-width: 220px; transition: transform 0.3s ease; }
    .logo-container img:hover { transform: scale(1.05); }

    /* Increased size for Growth Plan image */
    .growth-plan-image img {
      max-width: 800px;   /* Increased from 600px */
      height: auto;
      transition: transform 0.4s ease, box-shadow 0.4s ease;
      justify-self: end;
    }
    .growth-plan-image img:hover {
      transform: scale(1.12); /* Slightly larger hover effect */
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    /* Modified center-heading to shift left */
    .center-heading {
      position: relative;
      left: -30px;        /* Shift entire block left */
    }
    .center-heading h1,
    .center-heading h2 {
      text-align: left;
      margin: 0;
    }
    .center-heading h1 {
      font-size: 3rem; 
      font-weight: bold; 
      color: #ffcc00;
      animation: fadeInZoom 1s ease-in-out;
    }
    .center-heading h2 {
      font-size: 1rem; 
      font-weight: 500; 
      color: #bbb; 
      margin-top: 5px;
      letter-spacing: 2px; 
      text-transform: uppercase;
      animation: slideIn 1.2s ease-in-out;
    }

    @keyframes fadeInZoom {
      0% { opacity: 0; transform: scale(0.8); }
      100% { opacity: 1; transform: scale(1); }
    }
    @keyframes slideIn {
      0% { opacity: 0; transform: translateY(-10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .filter-box select {
      padding: 8px; border-radius: 6px; border: 1px solid #ccc;
      font-size: 14px; background: #2e2e2e; color: #f1f1f1;
    }

    .card {
      background: #2a2a2a; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.4);
      padding: 15px; margin-bottom: 20px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 6px 14px rgba(0,0,0,0.6); }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table th, table td { padding: 10px; text-align: center; }
    table th { background: #444; color: #fff; }
    table tr:nth-child(even) { background: #3a3a3a; }

    .title { font-size: 1.2rem; color: #ffcc00; margin-bottom: 10px; }

    .export-buttons button {
      background: #ffb400; border: none; padding: 10px 15px; color: #000;
      font-size: 14px; border-radius: 6px; margin-right: 10px; cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    .export-buttons button:hover { background: #e09c00; transform: scale(1.05); }

    .half-section { display: flex; gap: 20px; margin-bottom: 20px; }
    .half-section .card { flex: 1; }

    .counter { font-weight: bold; font-size: 1.2rem; color: #ffcc00; position: relative; }
    .shape { position: absolute; font-size: 18px; color: #ffcc00; animation: fly 1.2s ease-out forwards; }

    @keyframes fly {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header-container">
    <div class="logo-container">
      <a href="https://imgbb.com/" target="_blank">
        <img src="https://i.ibb.co/HTjXVFtf/recto-logo-1.jpg" alt="Retrotech Logo">
      </a>
    </div>
    <div class="center-heading">
      <h1>OKR</h1>
      <h2>Performance Management System</h2>
    </div>
    <div class="growth-plan-image">
      <a href="https://ibb.co/svkt8tT5" target="_blank">
        <img src="https://i.ibb.co/VWr3f3FH/Screenshot-2025-07-29-235227.png" alt="Growth Plan">
      </a>
    </div>
  </div>

  <!-- Welcome -->
  <header style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
    <h2>ðŸ‘‹ Welcome, <%= username %>
      <% if (dojData && dojData[username.toUpperCase()]) { %>
        <span style="font-size:0.9rem; color:#ffcc00;">
          (Joined: 
          <%= new Date(dojData[username.toUpperCase()]).toLocaleDateString('en-GB', 
              { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-') %>)
        </span>
      <% } %>
    </h2>
    <form method="GET" action="/dashboard" class="filter-box">
  <select name="range" onchange="this.form.submit()">
    <option value="ALL_TIME" <%= selectedRange === 'ALL_TIME' ? 'selected' : '' %>>All Time</option>
    <option value="LAST_N_DAYS:7" <%= selectedRange === 'LAST_N_DAYS:7' ? 'selected' : '' %>>Last 7 Days</option>
    <option value="LAST_N_DAYS:30" <%= selectedRange === 'LAST_N_DAYS:30' ? 'selected' : '' %>>Last 30 Days</option>
    <option value="LAST_N_DAYS:90" <%= selectedRange === 'LAST_N_DAYS:90' ? 'selected' : '' %>>Last 3 Months</option>
    <option value="LAST_N_DAYS:180" <%= selectedRange === 'LAST_N_DAYS:180' ? 'selected' : '' %>>Last 6 Months</option>
    <option value="LAST_N_DAYS:365" <%= selectedRange === 'LAST_N_DAYS:365' ? 'selected' : '' %>>Last 12 Months</option>
    <option value="THIS_MONTH" <%= selectedRange === 'THIS_MONTH' ? 'selected' : '' %>>This Month</option>
    <option value="LAST_MONTH" <%= selectedRange === 'LAST_MONTH' ? 'selected' : '' %>>Last Month</option>
  </select>
</form>

  </header>
  <p style="color: #ffcc00;">ðŸ“Š Showing records for: <%= selectedRange %></p>

  <!-- Your Performance -->
  <div class="half-section">
    <div class="card">
      <div class="title"><i class="fa-solid fa-chart-line"></i> Your Performance</div>
      <table>
        <thead><tr><th>Type</th><th>Count</th></tr></thead>
        <tbody>
          <tr><td>Leads</td><td class="counter" data-count="<%= leads.length %>">0</td></tr>
         <tr><td>Accounts</td><td class="counter" data-count="<%= uniqueAccounts.length %>">0</td></tr>

          <tr><td>Opportunities</td><td class="counter" data-count="<%= opportunities.length %>">0</td></tr>
          <tr><td>Deals</td><td class="counter" data-count="<%= deals.length %>">0</td></tr>
        </tbody>
      </table>
    </div>

    <% if (Object.keys(netData).length > 0) { %>
    <div class="card">
      <div class="title"><i class="fa-solid fa-sack-dollar"></i> Net Sales & Purchase</div>
      <table>
        <thead><tr><th>User</th><th>Net Sales ($)</th><th>Net Purchase ($)</th></tr></thead>
        <tbody>
          <% Object.entries(netData).forEach(([user, data]) => { %>
            <tr>
              <td><%= user %></td>
              <td><%= data.netSales || 0 %></td>
              <td><%= data.netPurchase || 0 %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } %>
  </div>

  <!-- Team Performance -->
  <% if (Object.keys(teamPerformance).length > 0) { %>
    <div class="card">
      <div class="title"><i class="fa-solid fa-users"></i> Team Performance</div>
      <table>
        <thead>
          <tr>
            <th>Member</th>
            <th>Date of Joining</th>
            <th>Leads</th>
            <th>Accounts</th>
            <th>Opportunities</th>
            <th>Deals</th>
          </tr>
        </thead>
        <tbody>
          <% Object.entries(teamPerformance).forEach(([member, data]) => { %>
            <tr>
              <td><%= member %></td>
              <td>
                <% if (dojData && dojData[member.toUpperCase()]) { %>
                  <%= new Date(dojData[member.toUpperCase()]).toLocaleDateString('en-GB', 
                      { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-') %>
                <% } else { %> - <% } %>
              </td>
              <td><%= data.leads || 0 %></td>
              <td><%= data.accounts || 0 %></td>
              <td><%= data.opportunities || 0 %></td>
              <td><%= data.deals || 0 %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>

  <!-- OKR -->
  <% if (okr && Object.keys(okr).length > 0) { %>
    <div class="card">
      <div class="title"><i class="fa-solid fa-bullseye"></i> ðŸŒŸ OKR Performance Summary</div>
      <p style="font-style: italic; color: #bbb;">Role: <%= roleKey.replaceAll('_', ' ').toUpperCase() %></p>
      <table>
        <thead><tr><th>Objective</th><th>Target</th><th>Weight</th><th>Achieved</th><th>%</th></tr></thead>
        <tbody>
          <% let weightedScore = 0;
             Object.entries(okr).forEach(([objective, meta]) => {
              const achieved = achievements[objective] || 0;
              const weight = meta.WEIGHTAGE;
              const percent = meta.TARGET ? ((achieved / meta.TARGET) * 100) : 0;
              weightedScore += (weight * percent) / 100;
          %>
            <tr>
              <td><%= objective %></td>
              <td><%= meta.TARGET %></td>
              <td><%= weight %>%</td>
              <td><%= achieved %></td>
              <td><%= percent.toFixed(1) %> %</td>
            </tr>
          <% }); %>
          <tr style="background:#444; font-weight:bold;">
            <td colspan="4">Overall Achievement</td>
            <td><%= weightedScore.toFixed(1) %> %</td>
          </tr>
        </tbody>
      </table>
    </div>
  <% } %>

  <canvas id="userChart" width="1000" height="400" style="margin-top:20px;"></canvas>

  <!-- Export Buttons -->
  <div class="export-buttons">
    <button onclick="exportToExcel()">ðŸ“… Export to Excel</button>
    <button onclick="exportToPDF()">ðŸ“„ Export to PDF</button>
  </div>

  <script>
    // Counter Animation
    function addShapeAnimation(counter) {
      const shapes = ['fa-star', 'fa-draw-polygon'];
      const shapeCount = Math.floor(Math.random() * 10) + 20;
      for (let i = 0; i < shapeCount; i++) {
        const shape = document.createElement('i');
        shape.classList.add('fa-solid', shapes[Math.floor(Math.random() * shapes.length)], 'shape');
        shape.style.left = (Math.random() * 30) + 'px';
        counter.appendChild(shape);
        setTimeout(() => counter.removeChild(shape), 1200);
      }
    }

    document.querySelectorAll(".counter").forEach(counter => {
      const updateCount = () => {
        const target = +counter.getAttribute("data-count");
        const count = +counter.innerText;
        const increment = target / 50;
        if (count < target) {
          counter.innerText = Math.ceil(count + increment);
          addShapeAnimation(counter);
          setTimeout(updateCount, 50);
        } else {
          counter.innerText = target;
          addShapeAnimation(counter);
        }
      };
      updateCount();
    });

    // Chart
  const chartData = JSON.parse('<%- JSON.stringify([leads.length, uniqueAccounts.length, opportunities.length, deals.length]) %>');

    new Chart(document.getElementById('userChart'), {
      type: 'bar',
      data: {
        labels: ['Leads', 'Accounts', 'Opportunities', 'Deals'],
        datasets: [{
          label: 'Your Record Count',
          data: chartData,
          backgroundColor: ['#1abc9c','#3498db','#9b59b6','#e74c3c']
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    function exportToExcel() {
      const wb = XLSX.utils.table_to_book(document.querySelector("table"), { sheet: "Summary" });
      XLSX.writeFile(wb, "User_Summary.xlsx");
    }

    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4');
      const canvas = await html2canvas(document.body, { scale: 2 });
      doc.addImage(canvas.toDataURL('image/png'), 'PNG', 20, 20, 550, (canvas.height * 550) / canvas.width);
      doc.save('User_Summary.pdf');
    }
  </script>
</body>
</html>