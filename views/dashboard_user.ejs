<!DOCTYPE html>
<html>
<head>
  <title>User Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: linear-gradient(120deg, #f4f7fc, #e6f0fa); /* same BG logic applied globally */
      padding: 20px;
      animation: fadeIn 1s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo-container img {
      max-width: 220px;
      transition: transform 0.3s ease;
    }
    .logo-container img:hover {
      transform: scale(1.05);
    }

    .growth-plan-image img {
      max-width: 400px;
      height: auto;
      transition: transform 0.4s ease, box-shadow 0.4s ease;
    }
    .growth-plan-image img:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .filter-box select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .card {
      background: linear-gradient(145deg, #ffffff, #f0f4fa); /* same bg gradient logic on cards */
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 20px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table th, table td {
      padding: 10px;
      text-align: center;
    }

    table th {
      background: #2c3e50;
      color: #fff;
    }

    table tr:nth-child(even) {
      background: #f9f9f9;
    }

    .title {
      font-size: 1.2rem;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .export-buttons button {
      background: #3498db;
      border: none;
      padding: 10px 15px;
      color: white;
      font-size: 14px;
      border-radius: 6px;
      margin-right: 10px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
    }

    .export-buttons button:hover {
      background: #2980b9;
      transform: scale(1.05);
    }

    /* Flex container for Your Performance & Net Sales side-by-side */
    .half-section {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .half-section .card {
      flex: 1;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header-container">
    <div class="logo-container">
      <a href="https://imgbb.com/" target="_blank">
        <img src="https://i.ibb.co/HTjXVFtf/recto-logo-1.jpg" alt="Retrotech Logo" border="0">
      </a>
    </div>
    <div class="growth-plan-image">
      <a href="https://ibb.co/5hsFDfk2" target="_blank">
        <img src="https://i.ibb.co/7tr4c6Qb/Screenshot-2025-07-29-184441.png" alt="Growth Plan Graphic" border="0">
      </a>
    </div>
  </div>

  <!-- Welcome and Filter -->
  <header style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
    <h2>ðŸ‘‹ Welcome, <%= username %></h2>
    <form method="GET" action="/dashboard" class="filter-box">
      <select name="range" onchange="this.form.submit()">
        <option value="LAST_N_DAYS:7" <%= selectedRange === 'LAST_N_DAYS:7' ? 'selected' : '' %>>Last 7 Days</option>
        <option value="LAST_N_DAYS:30" <%= selectedRange === 'LAST_N_DAYS:30' ? 'selected' : '' %>>Last 30 Days</option>
        <option value="THIS_MONTH" <%= selectedRange === 'THIS_MONTH' ? 'selected' : '' %>>This Month</option>
        <option value="LAST_MONTH" <%= selectedRange === 'LAST_MONTH' ? 'selected' : '' %>>Last Month</option>
      </select>
    </form>
  </header>
  <p style="color: green;">ðŸ“Š Showing records created in: <%= selectedRange %></p>

  <!-- SIDE BY SIDE: Your Performance & Net Sales/Purchase -->
  <div class="half-section">
    <div class="card">
      <div class="title"><i class="fa-solid fa-chart-line"></i> Your Performance</div>
      <table>
        <thead>
          <tr><th>Type</th><th>Count</th></tr>
        </thead>
        <tbody>
          <tr><td>Leads</td><td><%= leads.length %></td></tr>
          <tr><td>Accounts</td><td><%= accounts.length %></td></tr>
          <tr><td>Opportunities</td><td><%= opportunities.length %></td></tr>
          <tr><td>Deals</td><td><%= deals.length %></td></tr>
        </tbody>
      </table>
    </div>

    <% if (Object.keys(netData).length > 0) { %>
    <div class="card">
      <div class="title"><i class="fa-solid fa-sack-dollar"></i> Net Sales & Purchase</div>
      <table>
        <thead>
          <tr><th>User</th><th>Net Sales ($)</th><th>Net Purchase ($)</th></tr>
        </thead>
        <tbody>
          <% Object.entries(netData).forEach(([user, data]) => { %>
            <tr>
              <td><%= user %></td>
              <td><%= data.netSales || 0 %></td>
              <td><%= data.netPurchase || 0 %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } %>
  </div>

  <!-- Team Performance -->
  <% if (Object.keys(teamPerformance).length > 0) { %>
    <div class="card">
      <div class="title"><i class="fa-solid fa-users"></i> Team Performance</div>
      <table>
        <thead>
          <tr><th>Member</th><th>Leads</th><th>Accounts</th><th>Opportunities</th><th>Deals</th></tr>
        </thead>
        <tbody>
          <% Object.entries(teamPerformance).forEach(([member, data]) => { %>
            <tr>
              <td><%= member %></td>
              <td><%= data.leads || 0 %></td>
              <td><%= data.accounts || 0 %></td>
              <td><%= data.opportunities || 0 %></td>
              <td><%= data.deals || 0 %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>

  <!-- OKR Performance Summary -->
  <% if (okr && Object.keys(okr).length > 0) { %>
    <div class="card">
      <div class="title"><i class="fa-solid fa-bullseye"></i> ðŸŒŸ OKR Performance Summary</div>
      <p style="font-style: italic; color: gray;">Role: <%= roleKey.replaceAll('_', ' ').toUpperCase() %></p>
      <table>
        <thead>
          <tr><th>Objective</th><th>Target</th><th>Weight</th><th>Achieved</th><th>%</th></tr>
        </thead>
        <tbody>
          <% 
            let weightedScore = 0;
            let totalWeight = 0;
            Object.entries(okr).forEach(([objective, meta]) => {
              const achieved = achievements[objective] || 0;
              const weight = meta.WEIGHTAGE;
              const percent = meta.TARGET ? ((achieved / meta.TARGET) * 100) : 0;
              weightedScore += (weight * percent) / 100;
              totalWeight += weight;
          %>
            <tr>
              <td><%= objective %></td>
              <td><%= meta.TARGET %></td>
              <td><%= weight %>%</td>
              <td><%= achieved %></td>
              <td><%= percent.toFixed(1) %> %</td>
            </tr>
          <% }); %>
          <tr style="background:#d1f7d1; font-weight:bold;">
            <td colspan="4">Overall Achievement</td>
            <td><%= weightedScore.toFixed(1) %> %</td>
          </tr>
        </tbody>
      </table>
    </div>
  <% } %>

  <!-- Chart -->
  <canvas id="userChart" width="1000" height="400" style="margin-top:20px;"></canvas>

  <!-- Buttons -->
  <div class="export-buttons">
    <button onclick="exportToExcel()">ðŸ“… Export to Excel</button>
    <button onclick="exportToPDF()">ðŸ“„ Export to PDF</button>
  </div>

  <script>
    const chartData = JSON.parse('<%- JSON.stringify([leads.length, accounts.length, opportunities.length, deals.length]) %>');
    const ctx = document.getElementById('userChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Leads', 'Accounts', 'Opportunities', 'Deals'],
        datasets: [{
          label: 'Your Record Count',
          data: chartData,
          backgroundColor: ['#1abc9c','#3498db','#9b59b6','#e74c3c']
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    function exportToExcel() {
      const table = document.querySelector("table");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Summary" });
      XLSX.writeFile(wb, "User_Summary.xlsx");
    }

    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4');
      const content = document.body;
      const canvas = await html2canvas(content, { scale: 2 });
      doc.addImage(canvas.toDataURL('image/png'), 'PNG', 20, 20, 550, (canvas.height * 550) / canvas.width);
      doc.save('User_Summary.pdf');
    }
  </script>
</body>
</html>
